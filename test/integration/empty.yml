---
- hosts: localhost
  become: true
  roles:
    - { role: awh-automysqlbackup,      tags: ['automysqlbackup'] }


  handlers:
    - name: start mysql
      command: "systemctl start mysqld"
      when: ansible_os_family == "RedHat"

    - name:  mysql start
      service:
        name: mysql
        state: started
      when: ansible_os_family == "Debian"

    - name: reload
      service:
        name: mysql
        state: restarted
      when: ansible_os_family == "Debian"

    - name: restart mysql
      command: "systemctl restart mysqld"
      when: ansible_os_family == "RedHat"

  pre_tasks:
    - name: Install mysql
      become: sudo
      apt:
        name: "{{ item }}"
#        update_cache: yes
        state: present
      with_items:
        - mysql-server
        - python-mysqldb
      when: ansible_os_family == "Debian"
      notify: mysql start

    - name: add yum repo
      get_url:
        url: "http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm"
        dest: "/tmp"
      when: ansible_os_family == "RedHat"

    - name: check
      stat:
        path: "/tmp/mysql-community-release-el7-5.noarch.rpm"
      register: path

    - command: "rpm -ivh /tmp/mysql-community-release-el7-5.noarch.rpm"
      become: true
      when: ansible_os_family == "RedHat" and path.stat.exists == False

    - name: Install mysql
      become: sudo
      yum:
        name: "{{ item }}"
#        update_cache: yes
        state: present
      with_items:
        - mysql-server
        - MySQL-python
      when: ansible_os_family == "RedHat"
      notify: start mysql

    - name: start mysql
      command: "systemctl start mysqld"
      when: ansible_os_family == "RedHat"

    - name:  mysql start
      service:
        name: mysql
        state: started
      when: ansible_os_family == "Debian"

    - name: create db
      mysql_db:
        name: toto_bdd
        state: present
      register: db_create

    - name: create mysql user
      mysql_user:
        name: toto
        state: present
      changed_when: db_create.changed
      notify:
        - reload
        - restart mysql




